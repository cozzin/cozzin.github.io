name: 'TTS Conversion'

on:
  push:
    branches:
      - main
    paths:
      - '_notes/**/*.md'
  workflow_dispatch:

jobs:
  tts-conversion:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyttsx3 markdown gtts
      
      - name: Install espeak (for pyttsx3)
        run: |
          sudo apt-get update
          sudo apt-get install -y espeak espeak-data libespeak1 libespeak-dev
      
      - name: Create audio directory
        run: |
          mkdir -p assets/audio
      
      - name: Convert markdown to audio
        run: |
          python << 'EOF'
          import os
          import re
          import glob
          from gtts import gTTS
          from pathlib import Path
          import hashlib
          
          def clean_markdown_for_tts(content):
              """ë§ˆí¬ë‹¤ìš´ì„ TTSì— ì í•©í•˜ê²Œ ì •ë¦¬"""
              # YAML front matter ì œê±°
              content = re.sub(r'^---\n.*?\n---\n', '', content, flags=re.DOTALL)
              
              # ë§ˆí¬ë‹¤ìš´ í—¤ë” ì •ë¦¬
              content = re.sub(r'^#+\s*', '', content, flags=re.MULTILINE)
              
              # ë§ˆí¬ë‹¤ìš´ ë§í¬ ì •ë¦¬ [í…ìŠ¤íŠ¸](url) -> í…ìŠ¤íŠ¸
              content = re.sub(r'\[([^\]]+)\]\([^)]+\)', r'\1', content)
              
              # ë§ˆí¬ë‹¤ìš´ ë³¼ë“œ, ì´íƒ¤ë¦­ ì œê±°
              content = re.sub(r'\*\*([^*]+)\*\*', r'\1', content)
              content = re.sub(r'\*([^*]+)\*', r'\1', content)
              
              # ì½”ë“œ ë¸”ë¡ ì œê±°
              content = re.sub(r'```[\s\S]*?```', '', content)
              content = re.sub(r'`([^`]+)`', r'\1', content)
              
              # ë¦¬ìŠ¤íŠ¸ ë§ˆì»¤ ì œê±°
              content = re.sub(r'^[\s]*[-*+]\s*', '', content, flags=re.MULTILINE)
              content = re.sub(r'^\s*\d+\.\s*', '', content, flags=re.MULTILINE)
              
              # ì²´í¬ë°•ìŠ¤ ì œê±°
              content = re.sub(r'- \[ \]', '', content)
              content = re.sub(r'- \[x\]', 'ì™„ë£Œ:', content)
              
              # ì´ëª¨ì§€ ì œê±°
              emoji_pattern = re.compile(
                  "["
                  "\U0001F600-\U0001F64F"  # emoticons
                  "\U0001F300-\U0001F5FF"  # symbols & pictographs
                  "\U0001F680-\U0001F6FF"  # transport & map symbols
                  "\U0001F1E0-\U0001F1FF"  # flags (iOS)
                  "]+", flags=re.UNICODE)
              content = emoji_pattern.sub(' ', content)
              
              # ì—°ì†ëœ ê³µë°± ì œê±°
              content = re.sub(r'\n\s*\n', '\n\n', content)
              content = re.sub(r'\s+', ' ', content)
              
              return content.strip()
          
          def generate_audio_summary(content):
              """ë…¸íŠ¸ì˜ ìš”ì•½ ìƒì„±"""
              sections = re.findall(r'^##\s+(.+?)$', content, re.MULTILINE)
              if sections:
                  summary = f"ì´ ë…¸íŠ¸ëŠ” {len(sections)}ê°œì˜ ì£¼ìš” ì„¹ì…˜ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤. "
                  summary += "ì„¹ì…˜ë“¤ì„ ì½ì–´ë“œë¦¬ê² ìŠµë‹ˆë‹¤. "
                  for i, section in enumerate(sections, 1):
                      summary += f"{i}ë²ˆì§¸ ì„¹ì…˜: {section}. "
                  return summary
              return ""
          
          def should_skip_file(file_path):
              """TTS ë³€í™˜ì„ ê±´ë„ˆë›¸ íŒŒì¼ì¸ì§€ í™•ì¸"""
              skip_files = ['README.md', 'tts_script.py', 'requirements.txt']
              return any(skip in file_path for skip in skip_files)
          
          # _notes í´ë”ì˜ ëª¨ë“  ë§ˆí¬ë‹¤ìš´ íŒŒì¼ ì²˜ë¦¬
          notes_files = glob.glob('_notes/**/*.md', recursive=True)
          
          for md_file in notes_files:
              if should_skip_file(md_file):
                  print(f"ê±´ë„ˆë›°ê¸°: {md_file}")
                  continue
              
              print(f"ì²˜ë¦¬ ì¤‘: {md_file}")
              
              try:
                  with open(md_file, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  # íŒŒì¼ëª…ì—ì„œ ì˜¤ë””ì˜¤ íŒŒì¼ëª… ìƒì„±
                  file_name = Path(md_file).stem
                  audio_path = f"assets/audio/{file_name}"
                  
                  # ì „ì²´ ë‚´ìš© ë³€í™˜
                  cleaned_content = clean_markdown_for_tts(content)
                  if cleaned_content:
                      # í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ê¸¸ë©´ ìš”ì•½ë§Œ ìƒì„±
                      if len(cleaned_content) > 5000:
                          summary_content = generate_audio_summary(content)
                          if summary_content:
                              tts = gTTS(text=summary_content, lang='ko', slow=False)
                              tts.save(f"{audio_path}_summary.mp3")
                              print(f"ìš”ì•½ ì˜¤ë””ì˜¤ ìƒì„±: {audio_path}_summary.mp3")
                      else:
                          tts = gTTS(text=cleaned_content, lang='ko', slow=False)
                          tts.save(f"{audio_path}.mp3")
                          print(f"ì˜¤ë””ì˜¤ ìƒì„±: {audio_path}.mp3")
                  
              except Exception as e:
                  print(f"ì˜¤ë¥˜ ë°œìƒ {md_file}: {e}")
          
          print("TTS ë³€í™˜ ì™„ë£Œ!")
          EOF
      
      - name: Commit and push audio files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add assets/audio/
          if git diff --staged --quiet; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          else
            git commit -m "ğŸ§ Auto-generated audio files from markdown notes"
            git push
          fi